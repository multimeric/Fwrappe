# Technical Implementation

## General

The main reason this plugin is needed is because in Quarto, adding attributes to an image doesn't apply them to the containing figure.
For example:
```markdown
![Caption](image.jpg){.some-class}
```
Rendered to the pandoc AST:
```bash
quarto render test.md --to native
```

Produces:
```
Pandoc
  Meta { unMeta = fromList [] }
  [ Figure
      ( "" , [] , [] )
      (Caption Nothing [ Plain [ Str "Caption" ] ])
      [ Plain
          [ Image
              ( "" , [ "some-class" ] , [] )
              [ Str "Caption" ]
              ( "image.jpg" , "" )
          ]
      ]
  ]
```

For this reason, this plugin has to run after `quarto`'s lua code, since this is what creates the figure div that we want to modify.

## HTML

Therefore, in HTML, we just have to find the figure Div and copy the `.wrap-XXX` class from its child Image back to itself.
Then, the styling is provided by a stylesheet that we generate dynamically.

## LaTeX

In LaTeX, nothing is so simple.
There is nothing like CSS, so instead we have to patch the `figure` environment into a `wrapfigure`, passing the appropriate options to it.

The reason why a width must be provided is because none of the other approaches work well.
I have tried the following:

- Using a `0pt` width for `wrapfigure`. In this case LaTeX is supposed to work out the width of the float.  However, this seems to be completely inaccurate, and results in text overlapping the image.
- Measuring the width of the figure using `calc` or `savebox`. These can't handle a floating environment such as a `figure`, and you get ` Missing \endgroup inserted.`
- Measuring the width of the image alone using `calc`. Unfortunately this doesn't work either, because it measures the full width of the original image, not the image as it would be displayed. This is because we miss out on all the Quarto magic that is applied to the figure environment.

